{% extends "base.html" %}

{% block title %}Registrar Avance - {{ task.title }} - Rutinas Operaciones CPB{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Task Summary -->
        <div class="card mb-4 {{ task.status_class }}" style="border-left-width: 4px;">
            <div class="card-body">
                <h5 class="task-title">{{ task.title }}</h5>
                <div class="d-flex flex-wrap gap-2 mb-2">
                    <span class="badge badge-responsible">
                        <i class="fas fa-user me-1"></i>{{ task.responsible }}
                    </span>
                    {% if task.due_date %}
                        <span class="badge {{ 'badge-overdue' if task.is_overdue else 'badge-due-date' }}">
                            <i class="fas fa-calendar me-1"></i>
                            {{ task.due_date.strftime('%d/%m/%Y') }}
                        </span>
                    {% endif %}
                </div>
                <div class="progress mb-2" style="height: 15px;">
                    <div class="progress-bar bg-success" 
                         role="progressbar" 
                         style="width: {{ task.progress_percentage }}%"
                         aria-valuenow="{{ task.progress_percentage }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        {{ task.progress_percentage }}%
                    </div>
                </div>
                <small class="text-muted">
                    {{ task.progress_updates|length }} avance{{ 's' if task.progress_updates|length != 1 else '' }} registrado{{ 's' if task.progress_updates|length != 1 else '' }}
                </small>
            </div>
        </div>
        
        <!-- Add Progress Form -->
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-plus me-2"></i>
                    Registrar Nuevo Avance
                </h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_progress', task_id=task.id) }}">
                    <div class="mb-3">
                        <label for="created_by" class="form-label">
                            <i class="fas fa-user me-1"></i>
                            Registrado por <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="created_by" 
                               name="created_by" 
                               required
                               maxlength="100"
                               value="{{ task.responsible }}"
                               placeholder="Nombre de quien registra el avance">
                        <div class="form-text">
                            Puede ser el responsable de la tarea u otra persona autorizada
                        </div>
                        <div class="invalid-feedback">
                            El nombre es obligatorio
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">
                            <i class="fas fa-clipboard-list me-1"></i>
                            Descripción del Avance <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" 
                                  id="description" 
                                  name="description" 
                                  rows="6"
                                  required
                                  maxlength="1000"
                                  placeholder="Describa el trabajo realizado, logros alcanzados, dificultades encontradas, próximos pasos, etc."></textarea>
                        <div class="form-text">
                            Sea específico sobre lo que se ha logrado y cualquier información relevante
                        </div>
                        <div class="invalid-feedback">
                            La descripción del avance es obligatoria
                        </div>
                    </div>

                    <div class="d-flex gap-2 justify-content-end">
                        <a href="{{ url_for('view_task_progress', task_id=task.id) }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Registrar Avance
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Instructions Card -->
<div class="row justify-content-center mt-4">
    <div class="col-lg-8">
        <div class="card border-info">
            <div class="card-body">
                <h6 class="text-info">
                    <i class="fas fa-lightbulb me-1"></i>
                    Consejos para Registrar Avances
                </h6>
                <ul class="mb-0 small">
                    <li><strong>Sea específico:</strong> Detalle exactamente qué trabajo se completó</li>
                    <li><strong>Incluya métricas:</strong> Porcentajes, cantidades, tiempos cuando sea relevante</li>
                    <li><strong>Mencione obstáculos:</strong> Problemas encontrados y cómo se resolvieron</li>
                    <li><strong>Próximos pasos:</strong> Qué se planea hacer a continuación</li>
                    <li><strong>Recursos utilizados:</strong> Personal, materiales, tiempo invertido</li>
                    <li><strong>Evidencias:</strong> Referencias a documentos, fotos, mediciones</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Character counter for description
    const descriptionInput = document.getElementById('description');
    if (descriptionInput) {
        const maxLength = descriptionInput.getAttribute('maxlength');
        const counter = document.createElement('div');
        counter.className = 'form-text text-end';
        descriptionInput.parentNode.appendChild(counter);
        
        function updateCounter() {
            const remaining = maxLength - descriptionInput.value.length;
            counter.textContent = `${descriptionInput.value.length}/${maxLength} caracteres`;
            counter.className = remaining < 100 ? 'form-text text-end text-warning' : 'form-text text-end text-muted';
        }
        
        descriptionInput.addEventListener('input', updateCounter);
        updateCounter();
    }
    
    // Auto-resize textarea
    const textarea = document.getElementById('description');
    if (textarea) {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    }
    
    // Focus on description field when page loads
    if (descriptionInput) {
        descriptionInput.focus();
    }
});
</script>
{% endblock %}